name: Build and Test (Yocto)

on:
  push:
    branches:
      - change-workflow
  pull_request:
    branches:
      - change-workflow

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  DOCKER_IMAGE: crops/poky:ubuntu-22.04
  HOST_WORKSPACE: /home/yean/code/starryos-workspace

jobs:
  build-and-test:
    runs-on: [self-hosted, yean-jiaolong]
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build and Test in Docker
        run: |
          BUILD_DIR=/tmp/starry-build-${{ github.run_id }}
          mkdir -p $BUILD_DIR
          chmod 777 $BUILD_DIR

          docker run --rm \
            --privileged \
            -v ${{ github.workspace }}:/source:ro \
            -v ${{ env.HOST_WORKSPACE }}/poky:/host-workspace/poky:ro \
            -v ${{ env.HOST_WORKSPACE }}/meta-starry:/host-workspace/meta-starry:ro \
            -v ${{ env.HOST_WORKSPACE }}/meta-openembedded:/host-workspace/meta-openembedded:ro \
            -v ${{ env.HOST_WORKSPACE }}/build/conf:/host-workspace/build/conf:ro \
            -v ${{ env.HOST_WORKSPACE }}/build/sstate-cache:/host-workspace/build/sstate-cache \
            -v ${{ env.HOST_WORKSPACE }}/build/downloads:/host-workspace/build/downloads \
            -v $BUILD_DIR:/build \
            -e HOST_PATH=${{ env.HOST_WORKSPACE }} \
            --network host \
            ${{ env.DOCKER_IMAGE }} \
            bash -c '
              set -e
              
              echo "=== Install Required Tools ==="
              apt-get update -qq
              apt-get install -y -qq rsync curl > /dev/null 2>&1
              
              # 安装repo工具
              curl -s https://storage.googleapis.com/git-repo-downloads/repo > /usr/local/bin/repo
              chmod a+x /usr/local/bin/repo
              
              # 符号链接缓存目录（复用下载和构建缓存）
              ln -sfn /host-workspace/sstate-cache $WORKSPACE/sstate-cache 2>/dev/null || true
              ln -sfn /host-workspace/downloads $WORKSPACE/downloads 2>/dev/null || true
              
              # 创建 build 目录
              mkdir -p $WORKSPACE/build/conf
              
              # repo sync所有依赖，但排除StarryOS主项目
              repo sync -c --no-clone-bundle -j8 || {
                echo "Warning: repo sync failed, using existing code"
              }
              
              echo "=== Overlay PR Code ==="
              # 保留repo sync的依赖，只覆盖StarryOS主代码
              rsync -av --delete \
                --exclude=arceos \
                --exclude=local_crates \
                --exclude=.git \
                --exclude=target \
                /pr-code/ /workspace/StarryOS/
              
              # 验证目录结构
              echo "=== Verify Structure ==="
              echo "StarryOS main code: $(ls /workspace/StarryOS/src 2>/dev/null | wc -l) files in src/"
              echo "arceos exists: $(test -d /workspace/StarryOS/arceos && echo YES || echo NO)"
              echo "local_crates exists: $(test -d /workspace/StarryOS/local_crates && echo YES || echo NO)"
              
              echo "=== Initialize Yocto Build ==="
              cd /workspace
              source poky/oe-init-build-env build
              
              # 显示缓存统计
              echo "=== Build Configuration ==="
              echo "Sstate cache: $(du -sh /workspace/sstate-cache 2>/dev/null | cut -f1 || echo N/A)"
              echo "Downloads: $(du -sh /workspace/downloads 2>/dev/null | cut -f1 || echo N/A)"
              
              echo "=== Building StarryOS ==="
              bitbake starry
              
              echo "=== Building Image ==="
              bitbake starry-minimal-image
              
              echo "=== Running QEMU Test ==="
              timeout 120 bash -c "
                runqemu starry-minimal-image nographic slirp &
                QEMU_PID=\$!
                sleep 60
                if ps -p \$QEMU_PID > /dev/null; then
                  echo \"✓ QEMU boot test passed\"
                  kill \$QEMU_PID 2>/dev/null || true
                  exit 0
                else
                  echo \"✗ QEMU exited unexpectedly\"
                  exit 1
                fi
              " || {
                echo "✗ Test timed out or failed"
                exit 1
              }
              
              echo "=== All tests passed ==="
            '

      - name: Cleanup
        if: always()
        run: |
          # 清理可能残留的容器
          docker ps -aq --filter "ancestor=${{ env.DOCKER_IMAGE }}" | xargs -r docker rm -f || true
