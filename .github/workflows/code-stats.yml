name: Code Statistics

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      output_branch:
        description: 'è¾“å‡ºç»“æžœçš„åˆ†æ”¯åç§°ï¼ˆé»˜è®¤ï¼šcode-stats-resultsï¼‰'
        required: false
        default: 'code-stats-results'
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œ
    - cron: '0 2 * * *'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout StarryOS
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Checkout test harness
        uses: actions/checkout@v4
        with:
          repository: kylin-x-kernel/starry-test-harness
          path: starry-test-harness

      - name: Install dependencies
        run: |
          # å®‰è£… tokei
          cargo install --locked tokei
          
          # å®‰è£… yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # éªŒè¯å®‰è£…
          tokei --version
          yq --version

      - name: Create whitelist config
        run: |
          cat > .code-stats-whitelist.yml << 'EOF'
          branch: master
          repos:
            - https://github.com/kylin-x-kernel/starry-ptrace
          EOF

      - name: Run code statistics
        run: |
          bash starry-test-harness/scripts/code_stats.sh \
            --workspace "${{ github.workspace }}" \
            --whitelist .code-stats-whitelist.yml \
            --output ./code-stats

      - name: Generate timestamp
        id: timestamp
        run: echo "date=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Upload statistics as artifact
        uses: actions/upload-artifact@v4
        with:
          name: code-statistics-${{ steps.timestamp.outputs.date }}
          path: |
            code-stats/loc.json
            code-stats/loc.md
          retention-days: 90

      - name: Commit and push to results branch
        env:
          OUTPUT_BRANCH: ${{ github.event.inputs.output_branch || 'code-stats-results' }}
          TIMESTAMP: ${{ steps.timestamp.outputs.date }}
        run: |
          # é…ç½® git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ›å»ºæˆ–åˆ‡æ¢åˆ°ç»“æžœåˆ†æ”¯
          git fetch origin ${OUTPUT_BRANCH}:${OUTPUT_BRANCH} || git checkout -b ${OUTPUT_BRANCH}
          git checkout ${OUTPUT_BRANCH} || git checkout --orphan ${OUTPUT_BRANCH}
          
          # æ¸…ç†å·¥ä½œç›®å½•ï¼ˆä¿ç•™ç»Ÿè®¡ç»“æžœï¼‰
          git rm -rf . || true
          
          # åˆ›å»ºç›®å½•ç»“æž„
          mkdir -p reports/${TIMESTAMP}
          
          # å¤åˆ¶ç»Ÿè®¡ç»“æžœ
          cp code-stats/loc.json reports/${TIMESTAMP}/
          cp code-stats/loc.md reports/${TIMESTAMP}/
          cp code-stats/loc.json reports/latest.json
          cp code-stats/loc.md reports/latest.md
          
          # åˆ›å»ºç´¢å¼•æ–‡ä»¶
          cat > reports/README.md << 'EOF'
          # StarryOS ä»£ç ç»Ÿè®¡åŽ†å²æŠ¥å‘Š
          
          ## æœ€æ–°æŠ¥å‘Š
          
          - [æœ€æ–°ç»Ÿè®¡ (JSON)](./latest.json)
          - [æœ€æ–°ç»Ÿè®¡ (Markdown)](./latest.md)
          
          ## åŽ†å²æŠ¥å‘Š
          
          EOF
          
          # åˆ—å‡ºæ‰€æœ‰åŽ†å²æŠ¥å‘Š
          for dir in reports/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "- [\`${dirname}\`](./${dirname}/loc.md)" >> reports/README.md
            fi
          done
          
          # æ·»åŠ å…ƒä¿¡æ¯
          cat > reports/latest-info.json << EOF
          {
            "timestamp": "${TIMESTAMP}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF
          
          # æäº¤æ›´æ”¹
          git add reports/
          git commit -m "ðŸ“Š ä»£ç ç»Ÿè®¡æŠ¥å‘Š - ${TIMESTAMP}" || echo "No changes to commit"
          
          # æŽ¨é€åˆ°è¿œç¨‹
          git push -f origin ${OUTPUT_BRANCH}
          
          echo " ç»Ÿè®¡ç»“æžœå·²æŽ¨é€åˆ°åˆ†æ”¯: ${OUTPUT_BRANCH}"
          echo " æŸ¥çœ‹æŠ¥å‘Š: https://github.com/${{ github.repository }}/tree/${OUTPUT_BRANCH}/reports"

      - name: Display statistics summary
        if: always()
        run: |
          echo "##  ä»£ç ç»Ÿè®¡æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f code-stats/loc.md ]; then
            cat code-stats/loc.md >> $GITHUB_STEP_SUMMARY
          else
            echo "ç»Ÿè®¡æ–‡ä»¶æœªç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo " ç»Ÿè®¡ç»“æžœå·²ä¿å­˜åˆ°åˆ†æ”¯: \`${{ github.event.inputs.output_branch || 'code-stats-results' }}\`" >> $GITHUB_STEP_SUMMARY
          echo " [æŸ¥çœ‹åŽ†å²æŠ¥å‘Š](https://github.com/${{ github.repository }}/tree/${{ github.event.inputs.output_branch || 'code-stats-results' }}/reports)" >> $GITHUB_STEP_SUMMARY
