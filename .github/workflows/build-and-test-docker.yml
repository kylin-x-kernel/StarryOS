name: Build and Test (Yocto Docker)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  DOCKER_IMAGE: yocto-builder:latest  # 替换为你的 Yocto 构建镜像
  STARRY_WORKSPACE: /workspace/starryos-workspace
  HOST_WORKSPACE: ~/starryos-workspace

jobs:
  build-and-test:
    runs-on: [self-hosted, Linux, X64, yocto]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 0

      - name: Prepare workspace
        run: |
          # 创建临时目录用于本次构建
          BUILD_ID="${{ github.run_id }}-${{ github.run_attempt }}"
          echo "BUILD_DIR=/tmp/starry-build-${BUILD_ID}" >> $GITHUB_ENV
          mkdir -p /tmp/starry-build-${BUILD_ID}

      - name: Build and Test in Docker
        run: |
          docker run --rm \
            --privileged \
            -v ${{ github.workspace }}:/source:ro \
            -v ${{ env.HOST_WORKSPACE }}:/host-workspace:ro \
            -v ${{ env.BUILD_DIR }}:/build \
            -e TERM=xterm \
            ${{ env.DOCKER_IMAGE }} \
            bash -c '
              set -e
              
              # 设置工作目录
              WORKSPACE=/build/starryos-workspace
              mkdir -p $WORKSPACE
              
              # 复制基础 Yocto 环境（从主机的 workspace）
              cp -r /host-workspace/* $WORKSPACE/ 2>/dev/null || true
              
              # 同步最新的 StarryOS 代码
              mkdir -p $WORKSPACE/StarryOS
              rsync -av --delete \
                --exclude ".git" \
                --exclude "target" \
                /source/ $WORKSPACE/StarryOS/
              
              # 初始化构建环境
              cd $WORKSPACE
              source poky/oe-init-build-env build
              
              # 构建内核
              echo "=== Building StarryOS kernel ==="
              bitbake starry
              
              # 构建镜像
              echo "=== Building minimal image ==="
              bitbake starry-minimal-image
              
              # 运行 QEMU 测试
              echo "=== Running QEMU test ==="
              timeout 120 bash -c "
                runqemu starry-minimal-image nographic slirp &
                QEMU_PID=\$!
                sleep 60
                if ps -p \$QEMU_PID > /dev/null; then
                  echo \"✔ QEMU boot test passed\"
                  kill \$QEMU_PID 2>/dev/null || true
                  exit 0
                else
                  echo \"❌ QEMU exited unexpectedly\"
                  exit 1
                fi
              " || {
                echo "❌ Test timed out or failed"
                exit 1
              }
              
              echo "=== All tests passed ==="
            '

      - name: Cleanup
        if: always()
        run: |
          # 清理临时构建目录
          rm -rf ${{ env.BUILD_DIR }} || true
          # 清理可能残留的 Docker 容器
          docker ps -q --filter "ancestor=${{ env.DOCKER_IMAGE }}" | xargs -r docker kill || true
